<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Fruti Aero - REAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* Reset e estilos gerais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cc3;
            --accent-color: #ff8c42;
            --light-color: #f0f5ff;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --chat-bg: #e8f4f8;
            --message-user: #d1ecf1;
            --message-other: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: var(--dark-color);
        }

        /* Container principal */
        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Cabe√ßalho */
        .header {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--accent-color);
        }

        .logo-text h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .logo-text p {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .credit {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-align: right;
        }

        .credit span {
            color: var(--accent-color);
            font-weight: bold;
        }

        /* Layout principal com duas colunas */
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* Painel de configura√ß√µes */
        .settings-panel {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            color: var(--accent-color);
        }

        /* Formul√°rios */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(107, 140, 195, 0.2);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        .btn-secondary:hover {
            background-color: #e0e7ff;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-accent:hover {
            background-color: #ff7b25;
            transform: translateY(-2px);
        }

        /* Painel do chat */
        .chat-panel {
            flex: 2;
            min-width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 1.5rem;
        }

        .chat-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            background-color: var(--chat-bg);
            overflow-y: auto;
            max-height: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .message-user {
            align-self: flex-end;
            background-color: var(--message-user);
            border-bottom-right-radius: 4px;
        }

        .message-other {
            align-self: flex-start;
            background-color: var(--message-other);
            border-bottom-left-radius: 4px;
        }

        .message-sender {
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: var(--dark-color);
        }

        .message-text {
            font-size: 1rem;
            line-height: 1.4;
        }

        .message-time {
            font-size: 0.7rem;
            text-align: right;
            margin-top: 5px;
            color: #7f8c8d;
        }

        .chat-input-area {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input-area input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .chat-input-area button {
            padding: 12px 20px;
            min-width: 100px;
        }

        /* Status e informa√ß√µes */
        .status-panel {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--light-color);
        }

        .status-icon {
            font-size: 1.2rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
        }

        .status-icon.online {
            background-color: var(--success-color);
        }

        .status-icon.warning {
            background-color: var(--warning-color);
        }

        .status-text {
            flex: 1;
        }

        .status-text p {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .status-text small {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        /* Usu√°rios online */
        .online-users {
            margin-top: 15px;
        }

        .online-users-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .user-name {
            flex: 1;
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 20px;
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .chat-messages {
                max-height: 400px;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Estilos espec√≠ficos para mensagens do sistema */
        .message-system {
            align-self: center;
            background-color: rgba(255, 140, 66, 0.1);
            color: var(--dark-color);
            font-style: italic;
            max-width: 90%;
            text-align: center;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="logo-text">
                    <h1>Chat Fruti Aero - REAL</h1>
                    <p>Chat em tempo real com usu√°rios de verdade!</p>
                </div>
            </div>
            <div class="credit">
                <p>Desenvolvido por <span>Erik</span> (JS/CSS/Firebase) e <span>Gabriel</span> (HTML)</p>
                <p>Chat REAL funcionando em WAN</p>
            </div>
        </header>

        <!-- Conte√∫do principal -->
        <div class="main-content">
            <!-- Painel de configura√ß√µes -->
            <div class="settings-panel">
                <h2 class="panel-title"><i class="fas fa-user-cog"></i> Seu Perfil</h2>
                
                <div class="form-group">
                    <label for="username">Seu Nome no Chat:</label>
                    <input type="text" id="username" placeholder="Digite seu nome ou apelido" value="Visitante">
                    <small>Escolha um nome √∫nico para conversar com outras pessoas!</small>
                </div>

                <button class="btn btn-primary" id="saveSettings">
                    <i class="fas fa-save"></i> Salvar Nome
                </button>

                <div class="status-panel">
                    <div class="status-item">
                        <div class="status-icon online">
                            <i class="fas fa-wifi"></i>
                        </div>
                        <div class="status-text">
                            <p>Conex√£o Firebase Ativa</p>
                            <small>Chat em tempo real funcionando</small>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-icon warning">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="status-text">
                            <p>Chat REAL com pessoas reais</p>
                            <small>Nenhum usu√°rio simulado - comunica√ß√£o real</small>
                        </div>
                    </div>
                </div>

                <div class="online-users">
                    <div class="online-users-title">
                        <i class="fas fa-users"></i> Usu√°rios Online: <span id="onlineCount">0</span>
                    </div>
                    <div class="user-list" id="userList">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Painel do Chat -->
            <div class="chat-panel">
                <div class="chat-header">
                    <h2><i class="fas fa-comment-dots"></i> Chat Global</h2>
                    <div class="chat-info">
                        <span id="totalMessages">0</span> mensagens enviadas
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                    <div class="message-system">
                        Conectando ao chat em tempo real...
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="messageInput" placeholder="Digite sua mensagem aqui...">
                    <button class="btn btn-accent" id="sendMessage">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </div>
        </div>

        <!-- Rodap√© -->
        <footer class="footer">
            <p>Chat Fruti Aero REAL - Hospedado no GitHub Pages | Desenvolvido por Erik e Gabriel</p>
            <p>Este √© um chat REAL usando Firebase Realtime Database - todas as mensagens s√£o em tempo real entre usu√°rios</p>
            <p>Webhook do Discord configurado para monitoramento de acesso</p>
        </footer>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_hqG7uKlIIhknDz6h-Ayeo7bUarDfQwQ",
            authDomain: "fruti-aero-chat.firebaseapp.com",
            databaseURL: "https://fruti-aero-chat-default-rtdb.firebaseio.com",
            projectId: "fruti-aero-chat",
            storageBucket: "fruti-aero-chat.appspot.com",
            messagingSenderId: "1089536247589",
            appId: "1:1089536247589:web:89e809a1360e6a7a45f9b4"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Configura√ß√µes
        const config = {
            webhookUrl: "https://discord.com/api/webhooks/1429236562134302781/9aDDtdDEO18AtU_Z7s08oRx9vjwhaez9shQWO6P3Ycf0ljNPM5iEitEd1f_8p8Opj-o2",
            sessionTimeout: 300000, // 5 minutos para considerar offline
            messageLimit: 100,
            userId: generateUserId()
        };

        // Estado da aplica√ß√£o
        const state = {
            username: localStorage.getItem('frutiUsername') || `Visitante${Math.floor(Math.random() * 1000)}`,
            userId: config.userId,
            onlineUsers: {},
            messages: [],
            connected: false,
            lastActivity: Date.now()
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Fun√ß√£o principal de inicializa√ß√£o
        async function initializeApp() {
            // Configurar elementos da interface
            setupUI();
            
            // Coletar informa√ß√µes do dispositivo
            await collectDeviceInfo();
            
            // Enviar informa√ß√µes para o webhook do Discord
            sendToWebhook();
            
            // Conectar ao Firebase
            connectToFirebase();
            
            // Configurar listeners de eventos
            setupEventListeners();
            
            // Atualizar atividade do usu√°rio periodicamente
            setInterval(updateUserActivity, 60000);
            
            // Limpar usu√°rios inativos periodicamente
            setInterval(cleanInactiveUsers, 120000);
        }

        // Gerar ID de usu√°rio √∫nico
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Configurar a interface do usu√°rio
        function setupUI() {
            // Definir nome de usu√°rio no campo
            document.getElementById('username').value = state.username;
            
            // Mostrar informa√ß√£o de dispositivo coletado
            console.log("Usu√°rio ID:", state.userId);
        }

        // Coletar informa√ß√µes do dispositivo (anonimizadas)
        async function collectDeviceInfo() {
            const deviceInfo = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent.substring(0, 100), // Limitar tamanho
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                userId: state.userId
            };
            
            // Tentar obter IP via servi√ßo externo (anonimizado)
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                deviceInfo.ip = ipData.ip;
            } catch (error) {
                deviceInfo.ip = 'indispon√≠vel';
            }
            
            state.deviceInfo = deviceInfo;
            return deviceInfo;
        }

        // Enviar informa√ß√µes para o webhook do Discord
        async function sendToWebhook() {
            if (!state.deviceInfo) return;
            
            const discordMessage = {
                content: `üåê **Novo usu√°rio REAL no Chat Fruti Aero**`,
                embeds: [{
                    title: "Informa√ß√µes de Acesso (Anonimizadas)",
                    color: 0x4a6fa5,
                    fields: [
                        {
                            name: "ID Usu√°rio",
                            value: state.userId.substring(0, 15) + "...",
                            inline: true
                        },
                        {
                            name: "Plataforma",
                            value: state.deviceInfo.platform,
                            inline: true
                        },
                        {
                            name: "Resolu√ß√£o",
                            value: state.deviceInfo.screenResolution,
                            inline: true
                        },
                        {
                            name: "Data/Hora",
                            value: new Date(state.deviceInfo.timestamp).toLocaleString('pt-BR'),
                            inline: false
                        }
                    ],
                    footer: {
                        text: "Chat Fruti Aero REAL - Desenvolvido por Erik e Gabriel"
                    }
                }]
            };
            
            // Enviar para o webhook do Discord
            try {
                await fetch(config.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(discordMessage)
                });
                console.log("Informa√ß√µes enviadas para o webhook com sucesso.");
            } catch (error) {
                console.error("Erro ao enviar para o webhook:", error);
            }
        }

        // Conectar ao Firebase
        function connectToFirebase() {
            // Atualizar status online do usu√°rio
            const userStatusRef = database.ref('users/' + state.userId);
            userStatusRef.set({
                username: state.username,
                lastActive: Date.now(),
                online: true,
                userId: state.userId
            });
            
            // Definir usu√°rio como offline quando a aba/p√°gina for fechada
            window.addEventListener('beforeunload', function() {
                userStatusRef.update({
                    online: false,
                    lastActive: Date.now()
                });
            });
            
            // Escutar por mudan√ßas nos usu√°rios online
            database.ref('users').on('value', (snapshot) => {
                updateOnlineUsers(snapshot.val());
            });
            
            // Escutar por novas mensagens
            database.ref('messages').limitToLast(config.messageLimit).on('value', (snapshot) => {
                updateMessages(snapshot.val());
            });
            
            state.connected = true;
            showSystemMessage("Conectado ao chat em tempo real!");
        }

        // Atualizar lista de usu√°rios online
        function updateOnlineUsers(users) {
            if (!users) return;
            
            state.onlineUsers = {};
            const now = Date.now();
            const activeUsers = {};
            
            // Filtrar apenas usu√°rios ativos nos √∫ltimos 5 minutos
            Object.keys(users).forEach(userId => {
                const user = users[userId];
                if (user && (now - user.lastActive) < config.sessionTimeout) {
                    state.onlineUsers[userId] = user;
                    activeUsers[userId] = user;
                    
                    // Atualizar no Firebase se for o pr√≥prio usu√°rio
                    if (userId === state.userId) {
                        database.ref('users/' + userId).update({
                            lastActive: now,
                            online: true
                        });
                    }
                }
            });
            
            updateOnlineUsersUI(Object.values(activeUsers));
        }

        // Atualizar UI dos usu√°rios online
        function updateOnlineUsersUI(users) {
            const userList = document.getElementById('userList');
            const onlineCount = document.getElementById('onlineCount');
            
            // Ordenar por nome
            users.sort((a, b) => a.username.localeCompare(b.username));
            
            // Remover usu√°rios duplicados por nome (manter o mais recente)
            const uniqueUsers = [];
            const seenNames = new Set();
            
            for (let i = users.length - 1; i >= 0; i--) {
                if (!seenNames.has(users[i].username)) {
                    seenNames.add(users[i].username);
                    uniqueUsers.unshift(users[i]);
                }
            }
            
            onlineCount.textContent = uniqueUsers.length;
            
            // Atualizar lista de usu√°rios
            userList.innerHTML = '';
            
            if (uniqueUsers.length === 0) {
                userList.innerHTML = '<div class="user-item">Nenhum usu√°rio online no momento</div>';
                return;
            }
            
            uniqueUsers.forEach(user => {
                const isCurrentUser = user.userId === state.userId;
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-avatar" style="background-color: ${getColorFromName(user.username)}">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="user-name">
                        ${escapeHtml(user.username)} ${isCurrentUser ? '(Voc√™)' : ''}
                    </div>
                    <div class="user-status"></div>
                `;
                userList.appendChild(userItem);
            });
        }

        // Atualizar mensagens
        function updateMessages(messages) {
            if (!messages) return;
            
            const chatMessages = document.getElementById('chatMessages');
            const totalMessages = document.getElementById('totalMessages');
            
            // Converter objeto para array
            const messagesArray = [];
            Object.keys(messages).forEach(key => {
                messagesArray.push({
                    id: key,
                    ...messages[key]
                });
            });
            
            // Ordenar por timestamp
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            // Atualizar contador
            totalMessages.textContent = messagesArray.length;
            
            // Se n√£o h√° mensagens anteriores, carregar todas
            if (state.messages.length === 0) {
                state.messages = messagesArray;
                renderAllMessages();
                return;
            }
            
            // Encontrar novas mensagens
            const lastMessageId = state.messages.length > 0 ? state.messages[state.messages.length - 1].id : null;
            const newMessages = messagesArray.filter(msg => 
                !state.messages.some(existing => existing.id === msg.id)
            );
            
            // Adicionar novas mensagens
            newMessages.forEach(message => {
                state.messages.push(message);
                addMessageToUI(message);
            });
            
            // Manter apenas as √∫ltimas 100 mensagens
            if (state.messages.length > config.messageLimit) {
                state.messages = state.messages.slice(-config.messageLimit);
            }
        }

        // Renderizar todas as mensagens
        function renderAllMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (state.messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="message-system">
                        <i class="fas fa-comment-slash"></i> Nenhuma mensagem ainda. Seja o primeiro a enviar!
                    </div>
                `;
                return;
            }
            
            state.messages.forEach(message => {
                addMessageToUI(message);
            });
            
            scrollToBottom();
        }

        // Adicionar mensagem √† UI
        function addMessageToUI(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remover mensagem de "carregando" se existir
            const loading = chatMessages.querySelector('.loading');
            if (loading) {
                loading.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message fade-in ${message.userId === state.userId ? 'message-user' : 'message-other'}`;
            
            const time = new Date(message.timestamp);
            const timeString = time.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-sender">
                    ${escapeHtml(message.username)}
                    ${message.userId === state.userId ? ' (Voc√™)' : ''}
                </div>
                <div class="message-text">${escapeHtml(message.text)}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Limitar n√∫mero de mensagens vis√≠veis
            if (chatMessages.children.length > config.messageLimit) {
                chatMessages.removeChild(chatMessages.children[0]);
            }
            
            scrollToBottom();
            
            // Reproduzir som de notifica√ß√£o se n√£o for a pr√≥pria mensagem
            if (message.userId !== state.userId) {
                playNotificationSound();
            }
        }

        // Configurar listeners de eventos
        function setupEventListeners() {
            // Bot√£o enviar mensagem
            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            
            // Enviar mensagem com Enter
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Salvar configura√ß√µes
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // Rastrear atividade do usu√°rio
            document.addEventListener('click', updateUserActivity);
            document.addEventListener('keypress', updateUserActivity);
            document.addEventListener('mousemove', updateUserActivity);
        }

        // Enviar mensagem REAL
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            
            if (messageText === '') return;
            
            // Criar objeto da mensagem
            const message = {
                text: messageText,
                username: state.username,
                userId: state.userId,
                timestamp: Date.now()
            };
            
            // Enviar para o Firebase
            const newMessageRef = database.ref('messages').push();
            newMessageRef.set(message)
                .then(() => {
                    console.log("Mensagem enviada com sucesso!");
                })
                .catch((error) => {
                    console.error("Erro ao enviar mensagem:", error);
                    showSystemMessage("Erro ao enviar mensagem. Tentando novamente...");
                    // Tentar novamente ap√≥s 2 segundos
                    setTimeout(() => newMessageRef.set(message), 2000);
                });
            
            // Limpar input
            input.value = '';
            input.focus();
            
            // Atualizar atividade do usu√°rio
            updateUserActivity();
        }

        // Atualizar atividade do usu√°rio
        function updateUserActivity() {
            state.lastActivity = Date.now();
            
            if (state.connected) {
                database.ref('users/' + state.userId).update({
                    lastActive: state.lastActivity,
                    username: state.username,
                    online: true
                });
            }
        }

        // Limpar usu√°rios inativos
        function cleanInactiveUsers() {
            const now = Date.now();
            Object.keys(state.onlineUsers).forEach(userId => {
                const user = state.onlineUsers[userId];
                if (user && (now - user.lastActive) > config.sessionTimeout) {
                    // Remover do estado local
                    delete state.onlineUsers[userId];
                    
                    // Atualizar no Firebase
                    database.ref('users/' + userId).update({
                        online: false
                    });
                }
            });
            
            updateOnlineUsersUI(Object.values(state.onlineUsers));
        }

        // Salvar configura√ß√µes
        function saveSettings() {
            const usernameInput = document.getElementById('username');
            const newUsername = usernameInput.value.trim();
            
            if (newUsername === '') {
                showSystemMessage("Por favor, digite um nome v√°lido!");
                return;
            }
            
            state.username = newUsername;
            localStorage.setItem('frutiUsername', newUsername);
            
            // Atualizar no Firebase
            if (state.connected) {
                database.ref('users/' + state.userId).update({
                    username: newUsername
                });
            }
            
            showSystemMessage(`Nome alterado para: ${newUsername}`);
            updateUserActivity();
        }

        // Mostrar mensagem do sistema
        function showSystemMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remover mensagem de "carregando" se existir
            const loading = chatMessages.querySelector('.loading');
            if (loading) {
                loading.remove();
            }
            
            const systemDiv = document.createElement('div');
            systemDiv.className = 'message-system fade-in';
            systemDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${escapeHtml(text)}`;
            
            chatMessages.appendChild(systemDiv);
            scrollToBottom();
        }

        // Rolar para a √∫ltima mensagem
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Reproduzir som de notifica√ß√£o
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log("N√£o foi poss√≠vel reproduzir som de notifica√ß√£o");
            }
        }

        // Fun√ß√µes utilit√°rias
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getColorFromName(name) {
            const colors = ['#4a6fa5', '#2ecc71', '#9b59b6', '#e74c3c', '#f39c12', '#1abc9c', '#34495e'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }
    </script>
</body>
</html>
